#!/bin/sh

set -e
set -u

AI_DIR=${AI_DIR:-"${HOME}/ai"}
COMMAND_HISTORY_DIR=${AI_DIR}/commandhistory
HISTORY_DIR=${AI_DIR}/history
REPOS_DIR=${AI_DIR}/repos
SETTINGS_DIR=${AI_DIR}/settings

PORT=${PORT:-1337}

mkdir -p $COMMAND_HISTORY_DIR
mkdir -p $HISTORY_DIR
mkdir -p $REPOS_DIR
mkdir -p $SETTINGS_DIR/dotfiles

CLAUDE_JSON="${SETTINGS_DIR}/dotfiles/.claude.json"
if [ ! -f "$CLAUDE_JSON" ]; then
  op inject --force --in-file="${SETTINGS_DIR}/.claude.tmpl.json" --out-file="$CLAUDE_JSON"
fi

# NET_ADMIN  tcpdump
# NET_RAW    ping
# SYS_PTRACE strace

podman run --rm --interactive --tty \
  --cap-add=NET_ADMIN \
  --cap-add=NET_RAW \
  --cap-add=SYS_PTRACE \
  --volume ${COMMAND_HISTORY_DIR}:/commandhistory \
  --volume ${HISTORY_DIR}:/history \
  --volume ${REPOS_DIR}:/repos \
  --volume ${SETTINGS_DIR}:/settings \
  --volume $(pwd):/app \
  --workdir /app \
  --publish ${PORT} \
  ai:latest
